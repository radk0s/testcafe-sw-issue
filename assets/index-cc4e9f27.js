(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const W=console;class Ne{constructor(e,n,s,o=2e3,i=!0){this._callback=e,this._client_id=n,this._url=s,this._interval=o||2e3,this._stopOnError=i;const r=s.indexOf("/",s.indexOf("//")+2);this._frame_origin=s.substr(0,r),this._frame=window.document.createElement("iframe"),this._frame.style.visibility="hidden",this._frame.style.position="absolute",this._frame.style.display="none",this._frame.width=0,this._frame.height=0,this._frame.src=s}load(){return new Promise(e=>{this._frame.onload=()=>{e()},window.document.body.appendChild(this._frame),this._boundMessageEvent=this._message.bind(this),window.addEventListener("message",this._boundMessageEvent,!1)})}_message(e){e.origin===this._frame_origin&&e.source===this._frame.contentWindow&&(e.data==="error"?(W.error("CheckSessionIFrame: error message from check session op iframe"),this._stopOnError&&this.stop()):e.data==="changed"?(W.debug(e),W.debug("CheckSessionIFrame: changed message from check session op iframe"),this.stop(),this._callback()):W.debug("CheckSessionIFrame: "+e.data+" message from check session op iframe"))}start(e){W.debug("CheckSessionIFrame.start :"+e),this.stop();const n=()=>{this._frame.contentWindow.postMessage(this._client_id+" "+e,this._frame_origin)};n(),this._timer=window.setInterval(n,this._interval)}stop(){this._timer&&(W.debug("CheckSessionIFrame.stop"),window.clearInterval(this._timer),this._timer=null)}}const k={service_worker_not_supported_by_browser:"service_worker_not_supported_by_browser",token_aquired:"token_aquired",logout_from_another_tab:"logout_from_another_tab",logout_from_same_tab:"logout_from_same_tab",token_renewed:"token_renewed",token_timer:"token_timer",loginAsync_begin:"loginAsync_begin",loginAsync_error:"loginAsync_error",loginCallbackAsync_begin:"loginCallbackAsync_begin",loginCallbackAsync_end:"loginCallbackAsync_end",loginCallbackAsync_error:"loginCallbackAsync_error",refreshTokensAsync_begin:"refreshTokensAsync_begin",refreshTokensAsync:"refreshTokensAsync",refreshTokensAsync_end:"refreshTokensAsync_end",refreshTokensAsync_error:"refreshTokensAsync_error",refreshTokensAsync_silent_error:"refreshTokensAsync_silent_error",tryKeepExistingSessionAsync_begin:"tryKeepExistingSessionAsync_begin",tryKeepExistingSessionAsync_end:"tryKeepExistingSessionAsync_end",tryKeepExistingSessionAsync_error:"tryKeepExistingSessionAsync_error",silentLoginAsync_begin:"silentLoginAsync_begin",silentLoginAsync:"silentLoginAsync",silentLoginAsync_end:"silentLoginAsync_end",silentLoginAsync_error:"silentLoginAsync_error",syncTokensAsync_begin:"syncTokensAsync_begin",syncTokensAsync_end:"syncTokensAsync_end",syncTokensAsync_error:"syncTokensAsync_error"},b=(t,e=sessionStorage)=>{const n=h=>(e[`oidc.${t}`]=JSON.stringify({tokens:null,status:h}),Promise.resolve()),s=async()=>{if(!e[`oidc.${t}`])return e[`oidc.${t}`]=JSON.stringify({tokens:null,status:null}),{tokens:null,status:null};const h=JSON.parse(e[`oidc.${t}`]);return Promise.resolve({tokens:h.tokens,status:h.status})},o=h=>{e[`oidc.${t}`]=JSON.stringify({tokens:h})},i=async h=>{e[`oidc.session_state.${t}`]=h},r=async()=>e[`oidc.session_state.${t}`],u=h=>{e[`oidc.nonce.${t}`]=h.nonce},a=h=>{e[`oidc.jwk.${t}`]=JSON.stringify(h)},d=()=>JSON.parse(e[`oidc.jwk.${t}`]),l=async()=>({nonce:e[`oidc.nonce.${t}`]}),_=h=>{e[`oidc.dpop_nonce.${t}`]=h},f=()=>e[`oidc.dpop_nonce.${t}`],g=()=>e[`oidc.${t}`]?JSON.stringify({tokens:JSON.parse(e[`oidc.${t}`]).tokens}):null;let c={};return{clearAsync:n,initAsync:s,setTokens:o,getTokens:g,setSessionStateAsync:i,getSessionStateAsync:r,setNonceAsync:u,getNonceAsync:l,setLoginParams:h=>{c[t]=h,e[`oidc.login.${t}`]=JSON.stringify(h)},getLoginParams:()=>{const h=e[`oidc.login.${t}`];return c[t]||(c[t]=JSON.parse(h)),c[t]},getStateAsync:async()=>e[`oidc.state.${t}`],setStateAsync:async h=>{e[`oidc.state.${t}`]=h},getCodeVerifierAsync:async()=>e[`oidc.code_verifier.${t}`],setCodeVerifierAsync:async h=>{e[`oidc.code_verifier.${t}`]=h},setDemonstratingProofOfPossessionNonce:_,getDemonstratingProofOfPossessionNonce:f,setDemonstratingProofOfPossessionJwkAsync:a,getDemonstratingProofOfPossessionJwkAsync:d}},Ce=t=>decodeURIComponent(Array.prototype.map.call(atob(t),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join("")),xe=t=>JSON.parse(Ce(t.split(".")[1].replace("-","+").replace("_","/"))),ae=t=>{try{return t&&Ie(t,".")===2?xe(t):null}catch(e){console.warn(e)}return null},Ie=(t,e)=>t.split(e).length-1,z={access_token_or_id_token_invalid:"access_token_or_id_token_invalid",access_token_invalid:"access_token_invalid",id_token_invalid:"id_token_invalid"};function Le(t,e,n){if(t.issuedAt){if(typeof t.issuedAt=="string")return parseInt(t.issuedAt,10)}else return e&&e.iat?e.iat:n&&n.iat?n.iat:new Date().getTime()/1e3;return t.issuedAt}const _e=(t,e=null,n)=>{if(!t)return null;let s;const o=typeof t.expiresIn=="string"?parseInt(t.expiresIn,10):t.expiresIn;t.accessTokenPayload!==void 0?s=t.accessTokenPayload:s=ae(t.accessToken);const i=t.idTokenPayload?t.idTokenPayload:ae(t.idToken),r=i&&i.exp?i.exp:Number.MAX_VALUE,u=s&&s.exp?s.exp:t.issuedAt+o;t.issuedAt=Le(t,s,i);let a;t.expiresAt?a=t.expiresAt:n===z.access_token_invalid?a=u:n===z.id_token_invalid?a=r:a=r<u?r:u;const d={...t,idTokenPayload:i,accessTokenPayload:s,expiresAt:a};if(e!=null&&"refreshToken"in e&&!("refreshToken"in t)){const l=e.refreshToken;return{...d,refreshToken:l}}return d},oe=(t,e,n)=>{if(!t)return null;if(!t.issued_at){const o=new Date().getTime()/1e3;t.issued_at=o}const s={accessToken:t.access_token,expiresIn:t.expires_in,idToken:t.id_token,scope:t.scope,tokenType:t.token_type,issuedAt:t.issued_at};return"refresh_token"in t&&(s.refreshToken=t.refresh_token),t.accessTokenPayload!==void 0&&(s.accessTokenPayload=t.accessTokenPayload),t.idTokenPayload!==void 0&&(s.idTokenPayload=t.idTokenPayload),_e(s,e,n)},K=(t,e)=>{const n=new Date().getTime()/1e3,s=e-n;return Math.round(s-t)},Q=t=>t?K(0,t.expiresAt)>0:!1,We=async(t,e=200,n=50)=>{let s=n;if(!t.tokens)return null;for(;!Q(t.tokens)&&s>0;)await I(e),s=s-1;return{isTokensValid:Q(t.tokens),tokens:t.tokens,numberWaited:s-n}},ge=(t,e,n)=>{if(t.idTokenPayload){const s=t.idTokenPayload;if(n.issuer!==s.iss)return{isValid:!1,reason:`Issuer does not match (oidcServerConfiguration issuer) ${n.issuer} !== (idTokenPayload issuer) ${s.iss}`};const o=new Date().getTime()/1e3;if(s.exp&&s.exp<o)return{isValid:!1,reason:`Token expired (idTokenPayload exp) ${s.exp} < (currentTimeUnixSecond) ${o}`};const i=60*60*24*7;if(s.iat&&s.iat+i<o)return{isValid:!1,reason:`Token is used from too long time (idTokenPayload iat + timeInSevenDays) ${s.iat+i} < (currentTimeUnixSecond) ${o}`};if(s.nonce&&s.nonce!==e)return{isValid:!1,reason:`Nonce does not match (idTokenPayload nonce) ${s.nonce} !== (nonce) ${e}`}}return{isValid:!0,reason:""}},J=function(){const t=function(){let a,d;const l=(function(){const f={},g={setTimeout:function(h,y,m){f[y]=setTimeout(function(){h.postMessage(y),f[y]=null},m)},setInterval:function(h,y,m){f[y]=setInterval(function(){h.postMessage(y)},m)},clearTimeout:function(h,y){clearTimeout(f[y]),f[y]=null},clearInterval:function(h,y){clearInterval(f[y]),f[y]=null}};function c(h,y){const m=y.data[0],p=y.data[1],A=y.data[2];g[m]&&g[m](h,p,A)}this.onmessage=function(h){c(self,h)},this.onconnect=function(h){const y=h.ports[0];y.onmessage=function(m){c(y,m)}}}).toString();try{const f=new Blob(["(",l,")()"],{type:"application/javascript"});d=URL.createObjectURL(f)}catch{return null}const _=typeof process>"u";try{if(SharedWorker)return a=new SharedWorker(d),a.port}catch{_&&console.warn("SharedWorker not available")}try{if(Worker)return a=new Worker(d),a}catch{_&&console.warn("Worker not available")}return null}();if(!t){const a=typeof window>"u"?global:window;return{setTimeout:setTimeout.bind(a),clearTimeout:clearTimeout.bind(a),setInterval:setInterval.bind(a),clearInterval:clearInterval.bind(a)}}const e=function(){let a=0;return function(){return a++,a}}(),n={},s={};t.onmessage=function(a){const d=a.data,l=n[d];if(l){l(),n[d]=null;return}const _=s[d];_&&_()};function o(a,d){const l=e();return t.postMessage(["setTimeout",l,d]),n[l]=a,l}function i(a){t.postMessage(["clearTimeout",a]),n[a]=null}function r(a,d){const l=e();return t.postMessage(["setInterval",l,d]),s[l]=a,l}function u(a){t.postMessage(["clearInterval",a]),s[a]=null}return{setTimeout:o,clearTimeout:i,setInterval:r,clearInterval:u}}(),ce="7.7.0",ye=t=>{const e=t.appVersion,n=t.userAgent,s="-";let o=s;const i=[{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Chrome OS",r:/CrOS/},{s:"Linux",r:/(Linux|X11(?!.*CrOS))/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(Mac OS|MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(const u in i){const a=i[u];if(a.r.test(n)){o=a.s;break}}let r=s;switch(/Windows/.test(o)&&(r=/Windows (.*)/.exec(o)[1],o="Windows"),o){case"Mac OS":case"Mac OS X":case"Android":r=/(?:Android|Mac OS|Mac OS X|MacPPC|MacIntel|Mac_PowerPC|Macintosh) ([._\d]+)/.exec(n)[1];break;case"iOS":{const u=/OS (\d+)_(\d+)_?(\d+)?/.exec(e);r=u[1]+"."+u[2]+"."+(parseInt(u[3])|0);break}}return{os:o,osVersion:r}};function De(){const t=navigator.userAgent;let e,n=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(n[1]))return e=/\brv[ :]+(\d+)/g.exec(t)||[],{name:"ie",version:e[1]||""};if(n[1]==="Chrome"&&(e=t.match(/\bOPR|Edge\/(\d+)/),e!=null)){let s=e[1];if(!s){const o=t.split(e[0]+"/");o.length>1&&(s=o[1])}return{name:"opera",version:s}}return n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],(e=t.match(/version\/(\d+)/i))!=null&&n.splice(1,1,e[1]),{name:n[0].toLowerCase(),version:n[1]}}let le=null;const I=t=>new Promise(e=>J.setTimeout(e,t));let B;const ke=()=>{try{const t=ye(navigator).os==="Android"?240:150;B=new AbortController,fetch(`/OidcKeepAliveServiceWorker.json?minSleepSeconds=${t}`,{signal:B.signal}).catch(e=>{console.log(e)}),I(t*1e3).then(ke)}catch(t){console.log(t)}},$e=()=>{B&&B.abort()},Re=()=>fetch("/OidcKeepAliveServiceWorker.json",{headers:{"oidc-vanilla":"true"}}).then(t=>t.statusText==="oidc-service-worker").catch(t=>{console.log(t)}),Me=t=>async(e,n)=>{n(),await e.update();const s=await e.unregister();console.log(`Service worker unregistering ${s}`),await I(2e3),t.reload()},Ke=t=>!!(t.os==="iOS"&&t.osVersion.startsWith("12")||t.os==="Mac OS X"&&t.osVersion.startsWith("10_15_6")),v=t=>e=>new Promise(function(n,s){const o=new MessageChannel;o.port1.onmessage=function(i){i.data&&i.data.error?s(i.data.error):n(i.data)},t.active.postMessage(e,[o.port2])}),T=async(t,e)=>{if(typeof window>"u"||typeof navigator>"u"||!navigator.serviceWorker||!t)return null;const{name:n,version:s}=De();if(n==="chrome"&&parseInt(s)<=70||n==="opera"&&(!s||parseInt(s.split(".")[0])<80)||n==="ie")return null;const o=ye(navigator);if(Ke(o))return null;const i=await navigator.serviceWorker.register(t);try{await navigator.serviceWorker.ready}catch{return null}const r=async c=>v(i)({type:"clear",data:{status:c},configurationName:e}),u=async(c,h,y)=>{const m=await v(i)({type:"init",data:{oidcServerConfiguration:c,where:h,oidcConfiguration:{token_renew_mode:y.token_renew_mode,service_worker_convert_all_requests_to_cors:y.service_worker_convert_all_requests_to_cors}},configurationName:e}),p=m.version;return p!==ce&&(console.warn(`Service worker ${p} version mismatch with js client version ${ce}, unregistering and reloading`),await y.service_worker_update_require_callback(i,$e)),{tokens:oe(m.tokens,null,y.token_renew_mode),status:m.status}},a=()=>{le==null&&(le="not_null",ke())},d=c=>v(i)({type:"setSessionState",data:{sessionState:c},configurationName:e}),l=async()=>(await v(i)({type:"getSessionState",data:null,configurationName:e})).sessionState,_=c=>(sessionStorage[`oidc.nonce.${e}`]=c.nonce,v(i)({type:"setNonce",data:{nonce:c},configurationName:e})),f=async()=>{let c=(await v(i)({type:"getNonce",data:null,configurationName:e})).nonce;return c||(c=sessionStorage[`oidc.nonce.${e}`],console.warn("nonce not found in service worker, using sessionStorage")),{nonce:c}};let g={};return{clearAsync:r,initAsync:u,startKeepAliveServiceWorker:a,isServiceWorkerProxyActiveAsync:Re,setSessionStateAsync:d,getSessionStateAsync:l,setNonceAsync:_,getNonceAsync:f,setLoginParams:c=>{g[e]=c,localStorage[`oidc.login.${e}`]=JSON.stringify(c)},getLoginParams:()=>{const c=localStorage[`oidc.login.${e}`];return g[e]||(g[e]=JSON.parse(c)),g[e]},getStateAsync:async()=>{let c=(await v(i)({type:"getState",data:null,configurationName:e})).state;return c||(c=sessionStorage[`oidc.state.${e}`],console.warn("state not found in service worker, using sessionStorage")),c},setStateAsync:async c=>(sessionStorage[`oidc.state.${e}`]=c,v(i)({type:"setState",data:{state:c},configurationName:e})),getCodeVerifierAsync:async()=>{let c=(await v(i)({type:"getCodeVerifier",data:null,configurationName:e})).codeVerifier;return c||(c=sessionStorage[`oidc.code_verifier.${e}`],console.warn("codeVerifier not found in service worker, using sessionStorage")),c},setCodeVerifierAsync:async c=>(sessionStorage[`oidc.code_verifier.${e}`]=c,v(i)({type:"setCodeVerifier",data:{codeVerifier:c},configurationName:e})),setDemonstratingProofOfPossessionNonce:c=>{v(i)({type:"setDemonstratingProofOfPossessionNonce",data:{demonstratingProofOfPossessionNonce:c},configurationName:e})},getDemonstratingProofOfPossessionNonce:async()=>(await v(i)({type:"getDemonstratingProofOfPossessionNonce",data:null,configurationName:e})).demonstratingProofOfPossessionNonce,setDemonstratingProofOfPossessionJwkAsync:c=>{const h=JSON.stringify(c);v(i)({type:"setDemonstratingProofOfPossessionJwk",data:{demonstratingProofOfPossessionJwkJson:h},configurationName:e})},getDemonstratingProofOfPossessionJwkAsync:async()=>{const c=await v(i)({type:"getDemonstratingProofOfPossessionJwk",data:null,configurationName:e});return c.demonstratingProofOfPossessionJwkJson?JSON.parse(c.demonstratingProofOfPossessionJwkJson):null}}};async function me(t,e,n=!1,s=null){const o=u=>{t.tokens=u},{tokens:i,status:r}=await t.synchroniseTokensAsync(e,0,n,s,o);if(await T(t.configuration.service_worker_relative_url,t.configurationName)||await b(t.configurationName,t.configuration.storage).setTokens(t.tokens),!t.tokens){await t.destroyAsync(r);return}return t.timeoutId&&(t.timeoutId=U(t,i.refreshToken,t.tokens.expiresAt,s)),t.tokens}const U=(t,e,n,s=null)=>{const o=t.configuration.refresh_time_before_tokens_expiration_in_second;return J.setTimeout(async()=>{const i={timeLeft:K(o,n)};t.publishEvent(V.eventNames.token_timer,i),await me(t,e,!1,s)},1e3)},ie=(t,e,n)=>(s=null,o=null,i=null)=>{if(!e.silent_redirect_uri||!e.silent_login_uri)return Promise.resolve(null);try{n(k.silentLoginAsync_begin,{});let r="";if(o&&(s==null&&(s={}),s.state=o),i&&(s==null&&(s={}),s.scope=i),s!=null)for(const[_,f]of Object.entries(s))r===""?r=`?${encodeURIComponent(_)}=${encodeURIComponent(f)}`:r+=`&${encodeURIComponent(_)}=${encodeURIComponent(f)}`;const u=e.silent_login_uri+r,a=u.indexOf("/",u.indexOf("//")+2),d=u.substr(0,a),l=document.createElement("iframe");return l.width="0px",l.height="0px",l.id=`${t}_oidc_iframe`,l.setAttribute("src",u),document.body.appendChild(l),new Promise((_,f)=>{try{let g=!1;window.onmessage=h=>{if(h.origin===d&&h.source===l.contentWindow){const y=`${t}_oidc_tokens:`,m=`${t}_oidc_error:`,p=h.data;if(p&&typeof p=="string"&&!g){if(p.startsWith(y)){const A=JSON.parse(h.data.replace(y,""));n(k.silentLoginAsync_end,{}),l.remove(),g=!0,_(A)}else if(p.startsWith(m)){const A=JSON.parse(h.data.replace(m,""));n(k.silentLoginAsync_error,A),l.remove(),g=!0,f(new Error("oidc_"+A.error))}}}};const c=e.silent_login_timeout;setTimeout(()=>{g||(n(k.silentLoginAsync_error,{reason:"timeout"}),l.remove(),g=!0,f(new Error("timeout")))},c)}catch(g){l.remove(),n(k.silentLoginAsync_error,g),f(g)}})}catch(r){throw n(k.silentLoginAsync_error,r),r}},Ue=(t,e,n,s,o)=>(i=null,r=void 0)=>{i={...i};const u=(a,d,l)=>ie(e,n,s.bind(o))(a,d,l);return(async()=>{o.timeoutId&&J.clearTimeout(o.timeoutId);let a;i&&"state"in i&&(a=i.state,delete i.state);try{const d=n.extras?{...n.extras,...i}:i,l=await u({...d,prompt:"none"},a,r);if(l)return o.tokens=l.tokens,s(k.token_aquired,{}),o.timeoutId=U(o,o.tokens.refreshToken,o.tokens.expiresAt,i),{}}catch(d){return d}})()},Ve=(t,e,n)=>(s,o,i,r=!1)=>{const u=(a,d=void 0,l=void 0)=>ie(t.configurationName,n,t.publishEvent.bind(t))(a,d,l);return new Promise((a,d)=>{if(n.silent_login_uri&&n.silent_redirect_uri&&n.monitor_session&&s&&i&&!r){const l=()=>{t.checkSessionIFrame.stop();const _=t.tokens;if(_===null)return;const f=_.idToken,g=_.idTokenPayload;return u({prompt:"none",id_token_hint:f,scope:n.scope||"openid"}).then(c=>{const h=c.tokens.idTokenPayload;if(g.sub===h.sub){const y=c.sessionState;t.checkSessionIFrame.start(c.sessionState),g.sid===h.sid?console.debug("SessionMonitor._callback: Same sub still logged in at OP, restarting check session iframe; session_state:",y):console.debug("SessionMonitor._callback: Same sub still logged in at OP, session state has changed, restarting check session iframe; session_state:",y)}else console.debug("SessionMonitor._callback: Different subject signed into OP:",h.sub)}).catch(async c=>{console.warn("SessionMonitor._callback: Silent login failed, logging out other tabs:",c);for(const[h,y]of Object.entries(e))await y.logoutOtherTabAsync(n.client_id,g.sub)})};t.checkSessionIFrame=new Ne(l,o,s),t.checkSessionIFrame.load().then(()=>{t.checkSessionIFrame.start(i),a(t.checkSessionIFrame)}).catch(_=>{d(_)})}else a(null)})};var Je=Be,P=[],ue="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var F=0,je=ue.length;F<je;++F)P[F]=ue[F];function Fe(t){return P[t>>18&63]+P[t>>12&63]+P[t>>6&63]+P[t&63]}function He(t,e,n){for(var s,o=[],i=e;i<n;i+=3)s=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),o.push(Fe(s));return o.join("")}function Be(t){for(var e,n=t.length,s=n%3,o=[],i=16383,r=0,u=n-s;r<u;r+=i)o.push(He(t,r,r+i>u?u:r+i));return s===1?(e=t[n-1],o.push(P[e>>2]+P[e<<4&63]+"==")):s===2&&(e=(t[n-2]<<8)+t[n-1],o.push(P[e>>10]+P[e>>4&63]+P[e<<2&63]+"=")),o.join("")}const pe=()=>{const t=typeof window<"u"&&!!window.crypto,e=t&&!!window.crypto.subtle;return{hasCrypto:t,hasSubtleCrypto:e}},Z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Ge=t=>{const e=[];for(let n=0;n<t.byteLength;n+=1){const s=t[n]%Z.length;e.push(Z[s])}return e.join("")},qe=t=>Je(new Uint8Array(t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""),ee=t=>{const e=new Uint8Array(t),{hasCrypto:n}=pe();if(n)window.crypto.getRandomValues(e);else for(let s=0;s<t;s+=1)e[s]=Math.random()*Z.length|0;return Ge(e)};function Xe(t){const e=new ArrayBuffer(t.length),n=new Uint8Array(e);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n}function we(t){return new Promise((e,n)=>{crypto.subtle.digest("SHA-256",Xe(t)).then(s=>e(qe(new Uint8Array(s))),s=>n(s))})}const Ye=t=>{if(t.length<43||t.length>128)return Promise.reject(new Error("Invalid code length."));const{hasSubtleCrypto:e}=pe();return e?we(t):Promise.reject(new Error("window.crypto.subtle is unavailable."))},D={},ze=(t,e=window.sessionStorage,n)=>{if(!D[t]&&e){const o=e.getItem(t);o&&(D[t]=JSON.parse(o))}const s=1e3*n;return D[t]&&D[t].timestamp+s>Date.now()?D[t].result:null},Qe=(t,e,n=window.sessionStorage)=>{const s=Date.now();D[t]={result:e,timestamp:s},n&&n.setItem(t,JSON.stringify({result:e,timestamp:s}))},Ze=60*60,et=t=>async(e,n=Ze,s=window.sessionStorage,o=1e4)=>{const i=`${e}/.well-known/openid-configuration`,r=`oidc.server:${e}`,u=ze(r,s,n);if(u)return new ne(u);const a=await j(t)(i,{},o);if(a.status!==200)return null;const d=await a.json();return Qe(r,d,s),new ne(d)},j=t=>async(e,n={},s=1e4,o=0)=>{let i;try{const r=new AbortController;setTimeout(()=>r.abort(),s),i=await t(e,{...n,signal:r.signal})}catch(r){if(r.name==="AbortError"||r.message==="Network request failed"){if(o<=1)return await j(t)(e,n,s,o+1);throw r}else throw console.error(r.message),r}return i},te={refresh_token:"refresh_token",access_token:"access_token"},de=t=>async(e,n,s=te.refresh_token,o,i=1e4)=>{const r={token:n,token_type_hint:s,client_id:o},u=[];for(const d in r){const l=encodeURIComponent(d),_=encodeURIComponent(r[d]);u.push(`${l}=${_}`)}const a=u.join("&");return(await j(t)(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:a},i)).status!==200?{success:!1}:{success:!0}},tt=t=>async(e,n,s,o,i={},r,u=1e4)=>{for(const[g,c]of Object.entries(s))n[g]===void 0&&(n[g]=c);const a=[];for(const g in n){const c=encodeURIComponent(g),h=encodeURIComponent(n[g]);a.push(`${c}=${h}`)}const d=a.join("&"),l=await j(t)(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",...i},body:d},u);if(l.status!==200)return{success:!1,status:l.status,demonstratingProofOfPossessionNonce:null};const _=await l.json();let f=null;return l.headers.has(G)&&(f=l.headers.get(G)),{success:!0,data:oe(_,o,r),demonstratingProofOfPossessionNonce:f}},nt=(t,e)=>async(n,s)=>{s=s?{...s}:{};const o=ee(128),i=await Ye(o);await t.setCodeVerifierAsync(o),await t.setStateAsync(s.state),s.code_challenge=i,s.code_challenge_method="S256";let r="";if(s)for(const[u,a]of Object.entries(s))r===""?r+="?":r+="&",r+=`${u}=${encodeURIComponent(a)}`;e.open(`${n}${r}`)},G="DPoP-Nonce",st=t=>async(e,n,s,o,i=1e4)=>{n=n?{...n}:{},n.code_verifier=await t.getCodeVerifierAsync();const r=[];for(const _ in n){const f=encodeURIComponent(_),g=encodeURIComponent(n[_]);r.push(`${f}=${g}`)}const u=r.join("&"),a=await j(fetch)(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",...s},body:u},i);if(await Promise.all([t.setCodeVerifierAsync(null),t.setStateAsync(null)]),a.status!==200)return{success:!1,status:a.status};let d=null;a.headers.has(G)&&(d=a.headers.get(G));const l=await a.json();return{success:!0,data:{state:n.state,tokens:oe(l,null,o),demonstratingProofOfPossessionNonce:d}}},ot=t=>{const e=t.match(/^([a-z][\w-]+\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/);if(!e)throw new Error("Invalid URL");let n=e[6],s=e[7];if(s){const o=s.split("?");o.length===2&&(s=o[0],n=o[1])}return n.startsWith("?")&&(n=n.slice(1)),e&&{href:t,protocol:e[1],host:e[2],hostname:e[3],port:e[4],path:e[5],search:n,hash:s}},q=t=>{const e=ot(t),{search:n}=e;return it(n)},it=t=>{const e={};let n,s,o;const i=t.split("&");for(s=0,o=i.length;s<o;s++)n=i[s].split("="),e[decodeURIComponent(n[0])]=decodeURIComponent(n[1]);return e};function Ae(t){return new TextEncoder().encode(t)}function ve(t){return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+/g,"")}function rt(t){return encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(e,n){return String.fromCharCode(parseInt(n,16))})}function be(t){let e="";return t.forEach(function(n){e+=String.fromCharCode(n)}),ve(e)}function he(t){return ve(rt(t))}var Se={};Se.sign=(t,e,n,s="dpop+jwt")=>{t=Object.assign({},t),e.typ=s,e.alg="ES256",e.kid||(e.jwk={kty:t.kty,crv:t.crv,x:t.x,y:t.y});const o={protected:he(JSON.stringify(e)),payload:he(JSON.stringify(n))},i={name:"ECDSA",namedCurve:"P-256",hash:{name:"ES256"}},r=!0,u=["sign"];return window.crypto.subtle.importKey("jwk",t,i,r,u).then(function(a){const d=Ae(o.protected+"."+o.payload),l={name:"ECDSA",hash:{name:"SHA-256"}};return window.crypto.subtle.sign(l,a,d).then(function(_){return o.signature=be(new Uint8Array(_)),o.protected+"."+o.payload+"."+o.signature})})};const re={};re.generate=function(){const t={name:"ECDSA",namedCurve:"P-256"},e=!0,n=["sign","verify"];return window.crypto.subtle.generateKey(t,e,n).then(function(s){return window.crypto.subtle.exportKey("jwk",s.privateKey)})};re.neuter=function(t){const e=Object.assign({},t);return delete e.d,e.key_ops=["verify"],e};var Te={};Te.thumbprint=function(t){const e='{"crv":"CRV","kty":"EC","x":"X","y":"Y"}'.replace("CRV",t.crv).replace("X",t.x).replace("Y",t.y);return window.crypto.subtle.digest({name:"SHA-256"},Ae(e)).then(function(n){return be(new Uint8Array(n))})};const at=function(){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",e="0123456789abcdef";let n=0,s="";for(let o=0;o<36;o++)t[o]!=="-"&&t[o]!=="4"&&(n=Math.random()*16|0),t[o]==="x"?s+=e[n]:t[o]==="y"?(n&=3,n|=8,s+=e[n]):s+=t[o];return s},ct=()=>re.generate().then(function(t){return t}),Pe=(t,e="POST",n,s={})=>{const o={jit:btoa(at()),htm:e,htu:n,iat:Math.round(Date.now()/1e3),...s};return Te.thumbprint(t).then(function(i){return Se.sign(t,{},o).then(function(r){return r})})},lt=(t,e,n,s,o)=>(i=void 0,r=null,u=!1,a=void 0)=>{const d=r;return r={...r},(async()=>{const l=i||o.getPath();if("state"in r||(r.state=ee(16)),n(k.loginAsync_begin,{}),r)for(const _ of Object.keys(r))_.endsWith(":token_request")&&delete r[_];try{const _=u?e.silent_redirect_uri:e.redirect_uri;a||(a=e.scope);const f=e.extras?{...e.extras,...r}:r;f.nonce||(f.nonce=ee(12));const g={nonce:f.nonce},c=await T(e.service_worker_relative_url,t),h=await s(e.authority,e.authority_configuration);let y;if(c)c.setLoginParams({callbackPath:l,extras:d}),await c.initAsync(h,"loginAsync",e),await c.setNonceAsync(g),c.startKeepAliveServiceWorker(),y=c;else{const p=b(t,e.storage??sessionStorage);p.setLoginParams({callbackPath:l,extras:d}),await p.setNonceAsync(g),y=p}const m={client_id:e.client_id,redirect_uri:_,scope:a,response_type:"code",...f};await nt(y,o)(h.authorizationEndpoint,m)}catch(_){throw n(k.loginAsync_error,_),_}})()},ut=t=>async(e=!1)=>{try{t.publishEvent(k.loginCallbackAsync_begin,{});const n=t.configuration,s=n.client_id,o=e?n.silent_redirect_uri:n.redirect_uri,i=n.authority,r=n.token_request_timeout,u=await t.initAsync(i,n.authority_configuration),a=t.location.getCurrentHref(),d=q(a).session_state,l=await T(n.service_worker_relative_url,t.configurationName);let _,f,g,c;if(l)await l.initAsync(u,"loginCallbackAsync",n),await l.setSessionStateAsync(d),f=await l.getNonceAsync(),g=l.getLoginParams(),c=await l.getStateAsync(),l.startKeepAliveServiceWorker(),_=l;else{const w=b(t.configurationName,n.storage??sessionStorage);await w.setSessionStateAsync(d),f=await w.getNonceAsync(),g=w.getLoginParams(),c=await w.getStateAsync(),_=w}const h=q(a);if(h.iss&&h.iss!==u.issuer)throw console.error(),new Error(`issuer not valid (expected: ${u.issuer}, received: ${h.iss})`);if(h.state&&h.state!==c)throw new Error(`state not valid (expected: ${c}, received: ${h.state})`);const y={code:h.code,grant_type:"authorization_code",client_id:n.client_id,redirect_uri:o},m={};if(n.token_request_extras)for(const[w,L]of Object.entries(n.token_request_extras))m[w]=L;if(g&&g.extras)for(const[w,L]of Object.entries(g.extras))w.endsWith(":token_request")&&(m[w.replace(":token_request","")]=L);const p=u.tokenEndpoint,A={};if(n.demonstrating_proof_of_possession){const w=await ct();l?await l.setDemonstratingProofOfPossessionJwkAsync(w):await b(t.configurationName,n.storage).setDemonstratingProofOfPossessionJwkAsync(w),A.DPoP=await Pe(w,"POST",p)}const O=await st(_)(p,{...y,...m},A,t.configuration.token_renew_mode,r);if(!O.success)throw new Error("Token request failed");let $;const E=O.data.tokens,N=O.data.demonstratingProofOfPossessionNonce;if(O.data.state!==m.state)throw new Error("state is not valid");const{isValid:S,reason:Y}=ge(E,f.nonce,u);if(!S)throw new Error(`Tokens are not OpenID valid, reason: ${Y}`);if(l){if(E.refreshToken&&!E.refreshToken.includes("SECURED_BY_OIDC_SERVICE_WORKER"))throw new Error("Refresh token should be hidden by service worker");if(N&&E.accessToken&&E.accessToken.includes("SECURED_BY_OIDC_SERVICE_WORKER"))throw new Error("Demonstration of proof of possession require Access token not hidden by service worker")}if(l)await l.initAsync(o,"syncTokensAsync",n),$=l.getLoginParams(),N&&await l.setDemonstratingProofOfPossessionNonce(N);else{const w=b(t.configurationName,n.storage);$=w.getLoginParams(),N&&await w.setDemonstratingProofOfPossessionNonce(N)}return await t.startCheckSessionAsync(u.checkSessionIframe,s,d,e),t.publishEvent(k.loginCallbackAsync_end,{}),{tokens:E,state:"request.state",callbackPath:$.callbackPath}}catch(n){throw console.error(n),t.publishEvent(k.loginCallbackAsync_error,n),n}},fe={access_token:"access_token",refresh_token:"refresh_token"},dt=t=>async e=>{J.clearTimeout(t.timeoutId),t.timeoutId=null,t.checkSessionIFrame&&t.checkSessionIFrame.stop();const n=await T(t.configuration.service_worker_relative_url,t.configurationName);n?await n.clearAsync(e):await b(t.configurationName,t.configuration.storage).clearAsync(e),t.tokens=null,t.userInfo=null},ht=(t,e,n,s,o)=>async(i=void 0,r=null)=>{const u=t.configuration,a=await t.initAsync(u.authority,u.authority_configuration);i&&typeof i!="string"&&(i=void 0,s.warn("callbackPathOrUrl path is not a string"));const d=i??o.getPath();let l=!1;i&&(l=i.includes("https://")||i.includes("http://"));const _=l?i:o.getOrigin()+d,f=t.tokens?t.tokens.idToken:"";try{const c=a.revocationEndpoint;if(c){const h=[],y=t.tokens.accessToken;if(y&&u.logout_tokens_to_invalidate.includes(fe.access_token)){const p=de(n)(c,y,te.access_token,u.client_id);h.push(p)}const m=t.tokens.refreshToken;if(m&&u.logout_tokens_to_invalidate.includes(fe.refresh_token)){const p=de(n)(c,m,te.refresh_token,u.client_id);h.push(p)}h.length>0&&await Promise.all(h)}}catch(c){s.warn("logoutAsync: error when revoking tokens, if the error persist, you ay configure property logout_tokens_to_invalidate from configuration to avoid this error"),s.warn(c)}const g=t.tokens&&t.tokens.idTokenPayload?t.tokens.idTokenPayload.sub:null;await t.destroyAsync("LOGGED_OUT");for(const[c,h]of Object.entries(e))h!==t&&await t.logoutSameTabAsync(t.configuration.client_id,g);if(a.endSessionEndpoint){r||(r={id_token_hint:f},i!==null&&(r.post_logout_redirect_uri=_));let c="";if(r)for(const[h,y]of Object.entries(r))c===""?c+="?":c+="&",c+=`${h}=${encodeURIComponent(y)}`;o.open(`${a.endSessionEndpoint}${c}`)}else o.reload()},ft=t=>async(e=!1)=>{if(t.userInfo!=null&&!e)return t.userInfo;for(;t.tokens&&!Q(t.tokens);)await I(200);if(!t.tokens)return null;const n=t.tokens.accessToken;if(!n)return null;const s=(await t.initAsync(t.configuration.authority,t.configuration.authority_configuration)).userInfoEndpoint,o=await(async i=>{const r=await fetch(s,{headers:{authorization:`Bearer ${i}`}});return r.status!==200?null:r.json()})(n);return t.userInfo=o,o};class X{open(e){window.open(e,"_self")}reload(){window.location.reload()}getCurrentHref(){return window.location.href}getPath(){const e=window.location;return e.pathname+(e.search||"")+(e.hash||"")}getOrigin(){return window.origin}}const _t=()=>fetch;class ne{constructor(e){this.authorizationEndpoint=e.authorization_endpoint,this.tokenEndpoint=e.token_endpoint,this.revocationEndpoint=e.revocation_endpoint,this.userInfoEndpoint=e.userinfo_endpoint,this.checkSessionIframe=e.check_session_iframe,this.issuer=e.issuer,this.endSessionEndpoint=e.end_session_endpoint}}const x={},gt=(t,e=new X)=>(n,s="default")=>(x[s]||(x[s]=new V(n,s,t,e)),x[s]),yt=async t=>{const{parsedTokens:e,callbackPath:n}=await t.loginCallbackAsync();return t.timeoutId=U(t,e.refreshToken,e.expiresAt),{callbackPath:n}},kt=t=>Math.floor(Math.random()*t),se=class M{constructor(e,n="default",s,o=new X){this.initPromise=null,this.tryKeepExistingSessionPromise=null,this.loginPromise=null,this.loginCallbackPromise=null,this.loginCallbackWithAutoTokensRenewPromise=null,this.userInfoPromise=null,this.renewTokensPromise=null,this.logoutPromise=null;let i=e.silent_login_uri;e.silent_redirect_uri&&!e.silent_login_uri&&(i=`${e.silent_redirect_uri.replace("-callback","").replace("callback","")}-login`);let r=e.refresh_time_before_tokens_expiration_in_second??120;r>60&&(r=r-Math.floor(Math.random()*40)),this.location=o??new X;const u=e.service_worker_update_require_callback??Me(this.location);this.configuration={...e,silent_login_uri:i,monitor_session:e.monitor_session??!1,refresh_time_before_tokens_expiration_in_second:r,silent_login_timeout:e.silent_login_timeout??12e3,token_renew_mode:e.token_renew_mode??z.access_token_or_id_token_invalid,demonstrating_proof_of_possession:e.demonstrating_proof_of_possession??!1,authority_timeout_wellknowurl_in_millisecond:e.authority_timeout_wellknowurl_in_millisecond??1e4,logout_tokens_to_invalidate:e.logout_tokens_to_invalidate??["access_token","refresh_token"],service_worker_update_require_callback:u},this.getFetch=s??_t,this.configurationName=n,this.tokens=null,this.userInfo=null,this.events=[],this.timeoutId=null,this.synchroniseTokensAsync.bind(this),this.loginCallbackWithAutoTokensRenewAsync.bind(this),this.initAsync.bind(this),this.loginCallbackAsync.bind(this),this.subscribeEvents.bind(this),this.removeEventSubscription.bind(this),this.publishEvent.bind(this),this.destroyAsync.bind(this),this.logoutAsync.bind(this),this.renewTokensAsync.bind(this),this.initAsync(this.configuration.authority,this.configuration.authority_configuration)}subscribeEvents(e){const n=kt(9999999999999).toString();return this.events.push({id:n,func:e}),n}removeEventSubscription(e){const n=this.events.filter(s=>s.id!==e);this.events=n}publishEvent(e,n){this.events.forEach(s=>{s.func(e,n)})}static get(e="default"){const n=typeof process>"u";if(!Object.prototype.hasOwnProperty.call(x,e)&&n)throw Error(`OIDC library does seem initialized.
Please checkout that you are using OIDC hook inside a <OidcProvider configurationName="${e}"></OidcProvider> compoment.`);return x[e]}_silentLoginCallbackFromIFrame(){if(this.configuration.silent_redirect_uri&&this.configuration.silent_login_uri){const e=this.location,n=q(e.getCurrentHref());window.parent.postMessage(`${this.configurationName}_oidc_tokens:${JSON.stringify({tokens:this.tokens,sessionState:n.session_state})}`,e.getOrigin())}}_silentLoginErrorCallbackFromIFrame(){if(this.configuration.silent_redirect_uri&&this.configuration.silent_login_uri){const e=this.location,n=q(e.getCurrentHref());window.parent.postMessage(`${this.configurationName}_oidc_error:${JSON.stringify({error:n.error})}`,e.getOrigin())}}async silentLoginCallbackAsync(){try{await this.loginCallbackAsync(!0),this._silentLoginCallbackFromIFrame()}catch(e){console.error(e),this._silentLoginErrorCallbackFromIFrame()}}async initAsync(e,n){if(this.initPromise!==null)return this.initPromise;const s=async()=>{if(n!=null)return new ne({authorization_endpoint:n.authorization_endpoint,end_session_endpoint:n.end_session_endpoint,revocation_endpoint:n.revocation_endpoint,token_endpoint:n.token_endpoint,userinfo_endpoint:n.userinfo_endpoint,check_session_iframe:n.check_session_iframe,issuer:n.issuer});const o=await T(this.configuration.service_worker_relative_url,this.configurationName)?window.localStorage:null;return await et(this.getFetch())(e,this.configuration.authority_time_cache_wellknowurl_in_second??60*60,o,this.configuration.authority_timeout_wellknowurl_in_millisecond)};return this.initPromise=s(),this.initPromise.then(o=>(this.initPromise=null,o))}async tryKeepExistingSessionAsync(){if(this.tryKeepExistingSessionPromise!==null)return this.tryKeepExistingSessionPromise;const e=async()=>{let n;if(this.tokens!=null)return!1;this.publishEvent(k.tryKeepExistingSessionAsync_begin,{});try{const s=this.configuration,o=await this.initAsync(s.authority,s.authority_configuration);if(n=await T(s.service_worker_relative_url,this.configurationName),n){const{tokens:i}=await n.initAsync(o,"tryKeepExistingSessionAsync",s);if(i){n.startKeepAliveServiceWorker(),this.tokens=i;const r=n.getLoginParams(this.configurationName);this.timeoutId=U(this,this.tokens.refreshToken,this.tokens.expiresAt,r.extras);const u=await n.getSessionStateAsync();return await this.startCheckSessionAsync(o.check_session_iframe,s.client_id,u),this.publishEvent(k.tryKeepExistingSessionAsync_end,{success:!0,message:"tokens inside ServiceWorker are valid"}),!0}this.publishEvent(k.tryKeepExistingSessionAsync_end,{success:!1,message:"no exiting session found"})}else{s.service_worker_relative_url&&this.publishEvent(k.service_worker_not_supported_by_browser,{message:"service worker is not supported by this browser"});const i=b(this.configurationName,s.storage??sessionStorage),{tokens:r}=await i.initAsync();if(r){this.tokens=_e(r,null,s.token_renew_mode);const u=i.getLoginParams();this.timeoutId=U(this,r.refreshToken,this.tokens.expiresAt,u.extras);const a=await i.getSessionStateAsync();return await this.startCheckSessionAsync(o.check_session_iframe,s.client_id,a),this.publishEvent(k.tryKeepExistingSessionAsync_end,{success:!0,message:"tokens inside storage are valid"}),!0}}return this.publishEvent(k.tryKeepExistingSessionAsync_end,{success:!1,message:n?"service worker sessions not retrieved":"session storage sessions not retrieved"}),!1}catch(s){return console.error(s),n&&await n.clearAsync(),this.publishEvent(k.tryKeepExistingSessionAsync_error,"tokens inside ServiceWorker are invalid"),!1}};return this.tryKeepExistingSessionPromise=e(),this.tryKeepExistingSessionPromise.then(n=>(this.tryKeepExistingSessionPromise=null,n))}async startCheckSessionAsync(e,n,s,o=!1){await Ve(this,x,this.configuration)(e,n,s,o)}async loginAsync(e=void 0,n=null,s=!1,o=void 0,i=!1){return this.loginPromise!==null?this.loginPromise:i?Ue(window,this.configurationName,this.configuration,this.publishEvent.bind(this),this)(n,o):(this.loginPromise=lt(this.configurationName,this.configuration,this.publishEvent.bind(this),this.initAsync.bind(this),this.location)(e,n,s,o),this.loginPromise.then(r=>(this.loginPromise=null,r)))}async loginCallbackAsync(e=!1){if(this.loginCallbackPromise!==null)return this.loginCallbackPromise;const n=async()=>{const s=await ut(this)(e),o=s.tokens;return this.tokens=o,await T(this.configuration.service_worker_relative_url,this.configurationName)||b(this.configurationName,this.configuration.storage).setTokens(o),this.publishEvent(M.eventNames.token_aquired,o),{parsedTokens:o,state:s.state,callbackPath:s.callbackPath}};return this.loginCallbackPromise=n(),this.loginCallbackPromise.then(s=>(this.loginCallbackPromise=null,s))}async synchroniseTokensAsync(e,n=0,s=!1,o=null,i){for(;!navigator.onLine&&document.hidden;)await I(1e3),this.publishEvent(k.refreshTokensAsync,{message:"wait because navigator is offline and hidden"});let r=6;for(;!navigator.onLine&&r>0;)await I(1e3),r--,this.publishEvent(k.refreshTokensAsync,{message:`wait because navigator is offline try ${r}`});let u=Math.floor(Math.random()*15)+10;for(;document.hidden&&u>0;)await I(1e3),u--,this.publishEvent(k.refreshTokensAsync,{message:`wait because navigator is hidden try ${u}`});const a=document.hidden?n:n+1;o||(o={});const d=this.configuration,l=(f,g,c=null)=>ie(this.configurationName,this.configuration,this.publishEvent.bind(this))(f,g,c),_=async()=>{try{let f;const g=await T(d.service_worker_relative_url,this.configurationName);g?f=g.getLoginParams():f=b(this.configurationName,d.storage).getLoginParams();const c=await l({...f.extras,...o,prompt:"none"},f.state);if(c)return i(c.tokens),this.publishEvent(M.eventNames.token_renewed,{}),{tokens:c.tokens,status:"LOGGED"}}catch(f){if(console.error(f),this.publishEvent(k.refreshTokensAsync_silent_error,{message:"exceptionSilent",exception:f.message}),f&&f.message&&f.message.startsWith("oidc"))return i(null),this.publishEvent(k.refreshTokensAsync_error,{message:"refresh token silent"}),{tokens:null,status:"SESSION_LOST"}}return this.publishEvent(k.refreshTokensAsync_error,{message:"refresh token silent return"}),await this.synchroniseTokensAsync(null,a,s,o,i)};if(n>4)return i(null),this.publishEvent(k.refreshTokensAsync_error,{message:"refresh token"}),{tokens:null,status:"SESSION_LOST"};try{const{status:f,tokens:g,nonce:c}=await this.syncTokensInfoAsync(d,this.configurationName,this.tokens,s);switch(f){case"SESSION_LOST":return i(null),this.publishEvent(k.refreshTokensAsync_error,{message:"refresh token session lost"}),{tokens:null,status:"SESSION_LOST"};case"NOT_CONNECTED":return i(null),{tokens:null,status:null};case"TOKENS_VALID":return i(g),{tokens:g,status:"LOGGED_IN"};case"TOKEN_UPDATED_BY_ANOTHER_TAB_TOKENS_VALID":return i(g),this.publishEvent(M.eventNames.token_renewed,{reason:"TOKEN_UPDATED_BY_ANOTHER_TAB_TOKENS_VALID"}),{tokens:g,status:"LOGGED_IN"};case"LOGOUT_FROM_ANOTHER_TAB":return i(null),this.publishEvent(k.logout_from_another_tab,{status:"session syncTokensAsync"}),{tokens:null,status:"LOGGED_OUT"};case"REQUIRE_SYNC_TOKENS":return this.publishEvent(k.refreshTokensAsync_begin,{refreshToken:e,status:f,tryNumber:n}),await _();default:{if(this.publishEvent(k.refreshTokensAsync_begin,{refreshToken:e,status:f,tryNumber:n}),!e)return await _();const h=d.client_id,y=d.redirect_uri,m=d.authority,p={...d.token_request_extras?d.token_request_extras:{}};for(const[A,O]of Object.entries(o))A.endsWith(":token_request")&&(p[A.replace(":token_request","")]=O);return await(async()=>{const A={client_id:h,redirect_uri:y,grant_type:"refresh_token",refresh_token:g.refreshToken},O=await this.initAsync(m,d.authority_configuration),$=document.hidden?1e4:3e4*10,E=O.tokenEndpoint,N={};d.demonstrating_proof_of_possession&&(N.DPoP=await this.generateDemonstrationOfProofOfPossessionAsync(g.accessToken,E,"POST"));const S=await tt(this.getFetch())(E,A,p,g,N,d.token_renew_mode,$);if(S.success){const{isValid:Y,reason:w}=ge(S.data,c.nonce,O);if(!Y)return i(null),this.publishEvent(k.refreshTokensAsync_error,{message:`refresh token return not valid tokens, reason: ${w}`}),{tokens:null,status:"SESSION_LOST"};if(i(S.data),S.demonstratingProofOfPossessionNonce){const L=await T(d.service_worker_relative_url,this.configurationName);L?await L.setDemonstratingProofOfPossessionNonce(S.demonstratingProofOfPossessionNonce):await b(this.configurationName,d.storage).setDemonstratingProofOfPossessionNonce(S.demonstratingProofOfPossessionNonce)}return this.publishEvent(k.refreshTokensAsync_end,{success:S.success}),this.publishEvent(M.eventNames.token_renewed,{reason:"REFRESH_TOKEN"}),{tokens:S.data,status:"LOGGED_IN"}}else return this.publishEvent(k.refreshTokensAsync_silent_error,{message:"bad request",tokenResponse:S}),await this.synchroniseTokensAsync(e,a,s,o,i)})()}}}catch(f){return console.error(f),this.publishEvent(k.refreshTokensAsync_silent_error,{message:"exception",exception:f.message}),this.synchroniseTokensAsync(e,a,s,o,i)}}async generateDemonstrationOfProofOfPossessionAsync(e,n,s){const o=this.configuration,i={ath:await we(e)},r=await T(o.service_worker_relative_url,this.configurationName);let u=null,a;if(r)u=await r.getDemonstratingProofOfPossessionNonce(),a=await r.getDemonstratingProofOfPossessionJwkAsync();else{const d=b(this.configurationName,o.storage);a=await d.getDemonstratingProofOfPossessionJwkAsync(),u=await d.getDemonstratingProofOfPossessionNonce()}return u&&(i.nonce=u),await Pe(a,s,n,i)}async syncTokensInfoAsync(e,n,s,o=!1){const i={nonce:null};if(!s)return{tokens:null,status:"NOT_CONNECTED",nonce:i};let r=i;const u=await this.initAsync(e.authority,e.authority_configuration),a=await T(e.service_worker_relative_url,n);if(a){const{status:l,tokens:_}=await a.initAsync(u,"syncTokensAsync",e);if(l==="LOGGED_OUT")return{tokens:null,status:"LOGOUT_FROM_ANOTHER_TAB",nonce:i};if(l==="SESSIONS_LOST")return{tokens:null,status:"SESSIONS_LOST",nonce:i};if(!l||!_)return{tokens:null,status:"REQUIRE_SYNC_TOKENS",nonce:i};if(_.issuedAt!==s.issuedAt){const f=K(e.refresh_time_before_tokens_expiration_in_second,_.expiresAt)>0?"TOKEN_UPDATED_BY_ANOTHER_TAB_TOKENS_VALID":"TOKEN_UPDATED_BY_ANOTHER_TAB_TOKENS_INVALID",g=await a.getNonceAsync();return{tokens:_,status:f,nonce:g}}r=await a.getNonceAsync()}else{const l=b(n,e.storage??sessionStorage),{tokens:_,status:f}=await l.initAsync();if(_){if(f==="SESSIONS_LOST")return{tokens:null,status:"SESSIONS_LOST",nonce:i};if(_.issuedAt!==s.issuedAt){const g=K(e.refresh_time_before_tokens_expiration_in_second,_.expiresAt)>0?"TOKEN_UPDATED_BY_ANOTHER_TAB_TOKENS_VALID":"TOKEN_UPDATED_BY_ANOTHER_TAB_TOKENS_INVALID",c=await l.getNonceAsync();return{tokens:_,status:g,nonce:c}}}else return{tokens:null,status:"LOGOUT_FROM_ANOTHER_TAB",nonce:i};r=await l.getNonceAsync()}const d=K(e.refresh_time_before_tokens_expiration_in_second,s.expiresAt)>0?"TOKENS_VALID":"TOKENS_INVALID";return o?{tokens:s,status:"FORCE_REFRESH",nonce:r}:{tokens:s,status:d,nonce:r}}loginCallbackWithAutoTokensRenewAsync(){return this.loginCallbackWithAutoTokensRenewPromise!==null?this.loginCallbackWithAutoTokensRenewPromise:(this.loginCallbackWithAutoTokensRenewPromise=yt(this),this.loginCallbackWithAutoTokensRenewPromise.then(e=>(this.loginCallbackWithAutoTokensRenewPromise=null,e)))}userInfoAsync(e=!1){return this.userInfoPromise!==null?this.userInfoPromise:(this.userInfoPromise=ft(this)(e),this.userInfoPromise.then(n=>(this.userInfoPromise=null,n)))}async renewTokensAsync(e=null){if(this.renewTokensPromise!==null)return this.renewTokensPromise;if(this.timeoutId)return J.clearTimeout(this.timeoutId),this.renewTokensPromise=me(this,this.tokens.refreshToken,!0,e),this.renewTokensPromise.then(n=>(this.renewTokensPromise=null,n))}async destroyAsync(e){return await dt(this)(e)}async logoutSameTabAsync(e,n){this.configuration.monitor_session&&this.configuration.client_id===e&&n&&this.tokens&&this.tokens.idTokenPayload&&this.tokens.idTokenPayload.sub===n&&(this.publishEvent(k.logout_from_same_tab,{message:n}),await this.destroyAsync("LOGGED_OUT"))}async logoutOtherTabAsync(e,n){this.configuration.monitor_session&&this.configuration.client_id===e&&n&&this.tokens&&this.tokens.idTokenPayload&&this.tokens.idTokenPayload.sub===n&&(await this.destroyAsync("LOGGED_OUT"),this.publishEvent(k.logout_from_another_tab,{message:"SessionMonitor",sub:n}))}async logoutAsync(e=void 0,n=null){return this.logoutPromise?this.logoutPromise:(this.logoutPromise=ht(this,x,this.getFetch(),console,this.location)(e,n),this.logoutPromise.then(s=>(this.logoutPromise=null,s)))}};se.getOrCreate=(t,e)=>(n,s="default")=>gt(t,e)(n,s),se.eventNames=k;let V=se;const H=class Oe{constructor(e){this._oidc=e}subscribeEvents(e){return this._oidc.subscribeEvents(e)}removeEventSubscription(e){this._oidc.removeEventSubscription(e)}publishEvent(e,n){this._oidc.publishEvent(e,n)}static get(e="default"){return new Oe(V.get(e))}tryKeepExistingSessionAsync(){return this._oidc.tryKeepExistingSessionAsync()}loginAsync(e=void 0,n=null,s=!1,o=void 0,i=!1){return this._oidc.loginAsync(e,n,s,o,i)}logoutAsync(e=void 0,n=null){return this._oidc.logoutAsync(e,n)}silentLoginCallbackAsync(){return this._oidc.silentLoginCallbackAsync()}renewTokensAsync(e=null){return this._oidc.renewTokensAsync(e)}loginCallbackAsync(){return this._oidc.loginCallbackWithAutoTokensRenewAsync()}get tokens(){return this._oidc.tokens}get configuration(){return this._oidc.configuration}async generateDemonstrationOfProofOfPossessionAsync(e,n,s){return this._oidc.generateDemonstrationOfProofOfPossessionAsync(e,n,s)}async getValidTokenAsync(e=200,n=50){return We(this._oidc,e,n)}async userInfoAsync(e=!1){return this._oidc.userInfoAsync(e)}};H.getOrCreate=(t,e=new X)=>(n,s="default")=>new H(V.getOrCreate(t,e)(n,s)),H.eventNames=V.eventNames;let mt=H;class pt{getCustomHistory(){const e=()=>Math.random().toString(36).substr(2,6),n=(i,r)=>(u,a)=>{if(typeof i.CustomEvent=="function")return new i.CustomEvent(u,a);const d=a||{bubbles:!1,cancelable:!1,detail:void 0},l=r.createEvent("CustomEvent");return l.initCustomEvent(u,d.bubbles,d.cancelable,d.detail),l.prototype=i.Event.prototype,l},s=(i,r,u)=>({replaceState:(a,d)=>{const l=u(),_=d||i.history.state;i.history.replaceState({key:l,state:_},null,a),i.dispatchEvent(r("popstate"))}});return(()=>s(window,n(window,document),e))()}}const Ee={client_id:"interactive.public.short",redirect_uri:window.location.origin+"/testcafe-sw-issue/#/authentication/callback",silent_redirect_uri:window.location.origin+"/testcafe-sw-issue/#/authentication/silent-callback",scope:"openid profile email api offline_access",authority:"https://demo.duendesoftware.com",refresh_time_before_tokens_expiration_in_second:40,service_worker_relative_url:"/testcafe-sw-issue/OidcServiceWorker.js",service_worker_only:!1},wt=new pt;document.body.innerHTML='<div id="my-vanilla-app"></div>';const R=document.getElementById("my-vanilla-app"),At=window.location.href,C=mt.getOrCreate(()=>fetch)(Ee);C.tryKeepExistingSessionAsync().then(()=>{if(At.includes(Ee.redirect_uri)){R.innerHTML=`<div>
            <h1>@axa-fr/oidc-client demo</h1>
            <h2>Loading callback</h2>
        </div>`,C.loginCallbackAsync().then(()=>{wt.getCustomHistory().replaceState("/"),window.logout=()=>C.logoutAsync();const e=C.tokens;R.innerHTML=`<div>
            <h1>@axa-fr/oidc-client demo</h1>
            <button id="logout" onclick="window.logout()">Logout</button>
            <h2>Authenticated</h2>
            <pre>${JSON.stringify(e,null,"	")}</pre>
        </div>`});return}const t=C.tokens;t?(window.logout=()=>C.logoutAsync(),R.innerHTML=`<div>
            <h1>@axa-fr/oidc-client demo</h1>
            <button id="logout" onclick="window.logout()">Logout</button>
            <h2>Authenticated</h2>
            <pre>${JSON.stringify(t,null,"	")}</pre>
        </div>`):(window.login=()=>{R.innerHTML=`<div>
            <h1>@axa-fr/oidc-client demo</h1>
            <h2>Loading</h2>
        </div>`,C.loginAsync("/")},R.innerHTML=`<div>
            <h1>@axa-fr/oidc-client demo</h1>
            <button id="login" onclick="window.login()">Login</button>
        </div>`)});
